<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/Users/sylvainestevez/Documents/Projects/Web/noot.js/src/api/lib/resource.js - NOOT.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="NOOT.js"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.5.8</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/NOOT.html">NOOT</a></li>
                                <li><a href="../classes/NOOT.API.html">NOOT.API</a></li>
                                <li><a href="../classes/NOOT.API.DefaultRoutes.html">NOOT.API.DefaultRoutes</a></li>
                                <li><a href="../classes/NOOT.API.DefaultRoutes.Delete.html">NOOT.API.DefaultRoutes.Delete</a></li>
                                <li><a href="../classes/NOOT.API.DefaultRoutes.Get.html">NOOT.API.DefaultRoutes.Get</a></li>
                                <li><a href="../classes/NOOT.API.DefaultRoutes.Patch.html">NOOT.API.DefaultRoutes.Patch</a></li>
                                <li><a href="../classes/NOOT.API.DefaultRoutes.Post.html">NOOT.API.DefaultRoutes.Post</a></li>
                                <li><a href="../classes/NOOT.API.DefaultRoutes.Put.html">NOOT.API.DefaultRoutes.Put</a></li>
                                <li><a href="../classes/NOOT.API.Resource.html">NOOT.API.Resource</a></li>
                                <li><a href="../classes/NOOT.API.Route.html">NOOT.API.Route</a></li>
                                <li><a href="../classes/NOOT.Configurator.html">NOOT.Configurator</a></li>
                                <li><a href="../classes/NOOT.ContentType.html">NOOT.ContentType</a></li>
                                <li><a href="../classes/NOOT.CustomRequire.html">NOOT.CustomRequire</a></li>
                                <li><a href="../classes/NOOT.Error.html">NOOT.Error</a></li>
                                <li><a href="../classes/NOOT.Errors.html">NOOT.Errors</a></li>
                                <li><a href="../classes/NOOT.HTTP.html">NOOT.HTTP</a></li>
                                <li><a href="../classes/NOOT.Logger.html">NOOT.Logger</a></li>
                                <li><a href="../classes/NOOT.Mongoose.html">NOOT.Mongoose</a></li>
                                <li><a href="../classes/NOOT.Mongoose.Schema.html">NOOT.Mongoose.Schema</a></li>
                                <li><a href="../classes/NOOT.Namespace.html">NOOT.Namespace</a></li>
                                <li><a href="../classes/NOOT.NOOT.html">NOOT.NOOT</a></li>
                                <li><a href="../classes/NOOT.Object.html">NOOT.Object</a></li>
                                <li><a href="../classes/NOOT.TasksRunner.html">NOOT.TasksRunner</a></li>
                                <li><a href="../classes/NOOT.TasksRunner.Task.html">NOOT.TasksRunner.Task</a></li>
                                <li><a href="../classes/NOOT.Time.html">NOOT.Time</a></li>
                                <li><a href="../classes/NOOT.Time.Measure.html">NOOT.Time.Measure</a></li>
                                <li><a href="../classes/NOOT.Url.html">NOOT.Url</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/noot.html">noot</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /Users/sylvainestevez/Documents/Projects/Web/noot.js/src/api/lib/resource.js</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        /**
                         * Dependencies
                         */
                        var NOOT = require(&#x27;../../../&#x27;)(&#x27;object&#x27;, &#x27;url&#x27;, &#x27;time&#x27;, &#x27;errors&#x27;, &#x27;http&#x27;);
                        var Inflector = require(&#x27;inflected&#x27;);
                        var _ = require(&#x27;lodash&#x27;);
                        var qs = require(&#x27;querystring&#x27;);
                        var http = require(&#x27;http&#x27;);
                        
                        var QueryMode = require(&#x27;./query-mode&#x27;);
                        var Route = require(&#x27;./route&#x27;);
                        var DefaultRoutes = require(&#x27;./default-routes&#x27;);
                        var CountCache = require(&#x27;./count-cache&#x27;);
                        
                        
                        /***********************************************************************************************************************
                         * @class Resource
                         * @namespace NOOT.API
                         * @constructor
                         **********************************************************************************************************************/
                        var Resource = NOOT.Object.extend({
                        
                          model: null,
                          path: &#x27;&#x27;,
                          maxLimit: 0,
                          defaultLimit: 0,
                          countCacheExpiration: undefined,
                          defaultResponseStatusCode: undefined,
                          allowedResponseFields: undefined,
                          areFindsLean: false,
                          defaultResponseType: undefined,
                          allowedResponseTypes: undefined,
                        
                          methods: undefined,
                        
                          _routes: undefined,
                        
                          selectable: undefined,
                          _selectable: undefined,
                          nonSelectable: undefined,
                          writable: undefined,
                          _writable: undefined,
                          nonWritable: undefined,
                          sortable: undefined,
                          _sortable: undefined,
                          nonSortable: undefined,
                          filterable: undefined,
                          _filterable: undefined,
                          nonFilterable: undefined,
                        
                          /**
                           * Constructor
                           */
                          init: function() {
                            NOOT.required(this, &#x27;model&#x27;);
                            if (!(this.api instanceof require(&#x27;../index&#x27;))) throw new Error(&#x27;Not a NOOT.API&#x27;);
                            _.defaults(this, Resource._DEFAULTS);
                            Resource.validateMethods(this.methods);
                            this._buildPath();
                            this._buildFields();
                            this._countCache = CountCache.create({
                              model: this.model,
                              expiration: this.countCacheExpiration
                            });
                            this._buildRoutes();
                          },
                        
                          _buildRoutes: function() {
                            var self = this;
                            var routes = (NOOT.makeArray(this.routes) || []).concat(this.methods.map(function(methodName) {
                              return DefaultRoutes[Inflector.classify(methodName)];
                            }));
                        
                            this._routes = routes.map(function(route) {
                              return route.create({ resource: self });
                            });
                          },
                        
                          _buildPath: function() {
                            var path = this.path || NOOT.dasherize(Inflector.pluralize(this.model.modelName));
                            this.path = NOOT.Url.join(&#x27;/&#x27;, this.api.name || &#x27;&#x27;, path).replace(/\/$/, &#x27;&#x27;);
                          },
                        
                        
                          getCount: function(filter, callback) {
                            return this._countCache.getCount(filter, callback);
                          },
                        
                          /**
                           * Register a single route.
                           *
                           * @method registerRoute
                           * @chainable
                           * @param {Class} route A {{#crossLink &quot;NOOT.API.Route&quot;}}{{/crossLink}} **class** that will be instantiated
                           * by the resource
                           */
                          registerRoute: function(route) {
                            if (!Route.detect(route)) {
                              if (route instanceof Route) throw new Error(&#x27;You must register classes, not instances&#x27;);
                              throw new Error(&#x27;Not a subclass of NOOT.API.Route&#x27;);
                            }
                            this._routes.push(route);
                            return this;
                          },
                        
                          /**
                           * Register multiple routes.
                           *
                           * @method registerRoutes
                           * @chainable
                           * @param {Class} routes,... A list of arguments ({{#crossLink &quot;NOOT.API.Route&quot;}}{{/crossLink}} **classes**)
                           */
                          registerRoutes: function() {
                            _.flatten(NOOT.makeArray(arguments)).forEach(this.registerRoute.bind(this));
                            return this;
                          },
                        
                          /**
                           * Create a new item
                           *
                           * @async
                           * @method post
                           * @param {Request} req
                           * @param {Function} callback
                           */
                          post: function(req, callback) {
                            var self = this;
                            return this.model.create(this.filterFields(req.body, Resource.WRITE), function(err, item) {
                              if (err) return callback(new NOOT.Errors.fromMongoose(err));
                              return callback(null, { data: self.filterFields(item.toObject(), Resource.READ), statusCode: NOOT.HTTP.Created });
                            });
                          },
                        
                          find: function(query, callback) {
                            var self = this;
                            var options = this.parseQueryString(query.req.query);
                        
                            callback = callback || query.next;
                        
                            return this.getCount(options.filter, function(err, count) {
                              if (err) return callback(err);
                        
                              query.meta = self.getMeta(query.req, options, count);
                        
                              if (!count) {
                                query.data = [];
                                return callback(null, query);
                              }
                        
                              return self.model.find(options.filter, options.select)
                                .limit(options.limit)
                                .skip(options.offset)
                                .sort(options.sort)
                                .setOptions({ lean: self.areFindsLean })
                                .exec(function(err, items) {
                                  if (err) return callback(new NOOT.Errors.fromMongoose(err));
                                  query.data = items;
                                  query.statusCode = NOOT.HTTP.OK;
                                  return callback(null, query);
                                });
                            });
                          },
                        
                          findOne: function(query, callback) {
                            var options = this.parseQueryString(query.req.query);
                            return this.model.findById(this.parseId(query.req), options.select, { lean: this.areFindsLean }, function(err, item) {
                              if (err) return callback(new NOOT.Errors.fromMongoose(err));
                              if (!item) return callback(new NOOT.Errors.NotFound());
                              return callback(null, { data: item, statusCode: NOOT.HTTP.OK });
                            });
                          },
                        
                          update: function() {
                        
                          },
                        
                          create: function() {
                        
                          },
                        
                          remove: function() {
                        
                          },
                        
                        
                        
                        
                          get: function(req, callback) {
                            return this.parseId(req) ? this.getSingle(req, callback) : this.getMultiple(req, callback);
                          },
                        
                          /**
                           * Read a single item.
                           *
                           * @method getSingle
                           * @async
                           * @param {Request} req
                           * @param {Function} callback
                           */
                          getSingle: function(req, callback) {
                            var query = this.parseQueryString(req.query);
                            return this.model.findById(this.parseId(req), query.select, { lean: this.areFindsLean }, function(err, item) {
                              if (err) return callback(new NOOT.Errors.fromMongoose(err));
                              if (!item) return callback(new NOOT.Errors.NotFound());
                              return callback(null, { data: item, statusCode: NOOT.HTTP.OK });
                            });
                          },
                        
                          /**
                           * Read multiple items.
                           *
                           * @method getMultiple
                           * @async
                           * @param {Request} req
                           * @param {Function} callback
                           */
                          getMultiple: function(req, callback) {
                            var self = this;
                            var query = this.parseQueryString(req.query);
                        
                            return this.getCount(query.filter, function(err, count) {
                              if (err) return callback(err);
                        
                              var meta = self.getMeta(req, query, count);
                        
                              if (!count) return callback(null, { meta: meta, data: [] });
                        
                              return self.model.find(query.filter, query.select)
                                .limit(query.limit)
                                .skip(query.offset)
                                .sort(query.sort)
                                .setOptions({ lean: self.areFindsLean })
                                .exec(function(err, items) {
                                  if (err) return callback(new NOOT.Errors.fromMongoose(err));
                                  return callback(null, { meta: meta, data: items, statusCode: NOOT.HTTP.OK });
                                });
                            });
                          },
                        
                        
                          parseId: function(req) {
                            return req.param(req.idProperty || &#x27;id&#x27;);
                          },
                        
                          /**
                           *
                           *
                           * @method createResponse
                           * @param {Response} res
                           * @param {Object} [data]
                           * @param {Number} [status]
                           */
                          createResponse: function(res, data, status) {
                            if (!(res instanceof http.ServerResponse)) throw new Error(&#x27;Not an http response&#x27;);
                        
                            if (!status &amp;&amp; NOOT.isNumber(data)) {
                              status = data;
                              data = undefined;
                            }
                        
                            res.status(status || data &amp;&amp; data.statusCode || this.defaultResponseStatusCode);
                        
                            return this.getResponseHandler(res)(res, data);
                          },
                        
                        
                          getResponseHandler: function(res) {
                            var type = res.req.accepts(this.allowedResponseTypes) || this.defaultResponseType;
                            var handler;
                            switch (type) {
                              case &#x27;json&#x27;: handler = this.sendJSON; break;
                              default: handler = this.sendJSON;
                            }
                            return handler.bind(this);
                          },
                        
                          sendJSON: function(res, json) {
                            return res.json(json);
                          },
                        
                          /**
                           * @method patch
                           * @async
                           * @param {Request} req
                           * @param {Function} callback
                           */
                          patch: function(req, callback) {
                            var properties = this.filterFields(req.body, Resource.WRITE);
                            return this.model.update({ _id: this.parseId(req) }, { $set: properties }, function(err, updated) {
                              if (err) return callback(NOOT.Errors.fromMongoose(err));
                              if (!updated) return callback(new NOOT.Errors.NotFound());
                              return callback(null, { statusCode: NOOT.HTTP.NoContent });
                            });
                          },
                        
                          /**
                           * Delete a single item
                           *
                           * @method delete
                           * @async
                           * @param {Request} req
                           * @param {Function} callback
                           */
                          delete: function(req, callback) {
                            return this.model.remove({ _id: this.parseId(req) }, function(err, removed) {
                              if (err) return callback(new NOOT.Errors.fromMongoose(err));
                              if (!removed) return callback(new NOOT.Errors.NotFound());
                              return callback(null, { statusCode: NOOT.HTTP.NoContent });
                            });
                          },
                        
                          /**
                           * Parse offset, limit, filters, sorting and select from request query string
                           *
                           * @param {Object} query
                           * @returns {Object}
                           */
                          parseQueryString: function(query) {
                            return {
                              offset: parseInt(query.offset, 10) || 0,
                              limit: Math.min(parseInt(query.limit, 10) || this.defaultLimit, this.maxLimit),
                              filter: this.filterFields(query, Resource.FILTER),
                              sort: this.filterFields(query.sort, Resource.SORT) || &#x27;-_id&#x27;,
                              select: this.filterFields(query.select, Resource.SELECT) || this._selectable.join(&#x27; &#x27;)
                            };
                          },
                        
                          /**
                           * Build metadata for multiple reads (ie, GET without identifier)
                           *
                           * @param {Request} req
                           * @param {Object} query
                           * @param {Number} count
                           */
                          getMeta: function(req, query, count) {
                            var nextOffset = query.offset + query.limit;
                            var prevOffset = query.offset - query.limit;
                            return {
                              limit: query.limit,
                              offset: query.offset,
                              total: count,
                              next: nextOffset &lt; count ? this.getMetaNavLink(req, nextOffset, query.limit) : null,
                              prev: prevOffset &gt;= 0 ? this.getMetaNavLink(req, prevOffset, query.limit) : null
                            };
                          },
                        
                          /**
                           * Build new uri from the original, modifying limit and offset parameters
                           *
                           * @param {Request} req
                           * @param {Number} offset
                           * @param {Number} limit
                           * @returns {String}
                           */
                          getMetaNavLink: function(req, offset, limit) {
                            var query = _.clone(req.query);
                            query.offset = offset;
                            query.limit = limit;
                            return req._parsedUrl.pathname + &#x27;?&#x27; + qs.unescape(qs.stringify(query));
                          },
                        
                          /**
                           * Filter fields depending on query mode (read, write, select, sort...)
                           *
                           * @method filterFields
                           * @param {Array|Object} fields
                           * @param {QueryMode} queryMode
                           * @return {Array|Object}
                           */
                          filterFields: function(fields, queryMode) {
                            if (!(queryMode instanceof QueryMode)) throw new Error(&#x27;Invalid query mode: &#x27; + queryMode);
                            if (fields &amp;&amp; fields.toJSON) fields = fields.toJSON();
                        
                            switch (queryMode) {
                              case Resource.READ: return _.pick(fields, this._selectable);
                              case Resource.SELECT: return this.parseFieldsList(fields, this._selectable);
                              case Resource.WRITE: return _.pick(fields, this._writable);
                              case Resource.FILTER: return _.pick(fields, this._filterable);
                              case Resource.SORT: return this.parseFieldsList(fields, this._sortable);
                            }
                          },
                        
                          /**
                           * Parse fields from a comma separated list
                           *
                           * @param {String} fieldsStr
                           * @param {Array} allowedFields
                           * @returns {String}
                           */
                          parseFieldsList: function(fieldsStr, allowedFields) {
                            return (fieldsStr || &#x27;&#x27;)
                              .toString()
                              .split(/\s*,\s*/)
                              .filter(function(field) { return ~allowedFields.indexOf(field.replace(/^(\+|-)/, &#x27;&#x27;)); })
                              .join(&#x27; &#x27;);
                          },
                        
                          /**
                           * Build allowed fields for all types
                           *
                           * @private
                           */
                          _buildFields: function() {
                            var self = this;
                            [&#x27;selectable&#x27;, &#x27;sortable&#x27;, &#x27;writable&#x27;, &#x27;filterable&#x27;].forEach(this._buildFieldsForType.bind(this));
                            // Security : don&#x27;t allow sorting, writing and filtering on non selectable fields
                            [&#x27;sortable&#x27;, &#x27;writable&#x27;, &#x27;filterable&#x27;].forEach(function(type) {
                              self[&#x27;_&#x27; + type] = _.intersection(self._selectable, self[&#x27;_&#x27; + type]);
                            });
                          },
                        
                          /**
                           * Build allowed fields for a single type
                           *
                           * @param {String} type
                           * @private
                           */
                          _buildFieldsForType: function(type) {
                            var allowed = this[type];
                            var disallowed = this[&#x27;non&#x27; + Inflector.classify(type)];
                            if (!allowed) allowed = this._getModelPaths();
                            if (disallowed) allowed = allowed.filter(function(field) { return !~disallowed.indexOf(field); });
                            this[&#x27;_&#x27; + type] = allowed;
                          },
                        
                          /**
                           * Get an exhaustive list of paths for model (nested paths use dot notation)
                           *
                           * @returns {Array}
                           * @private
                           */
                          _getModelPaths: function() {
                            return Object.keys(this.model.schema.paths);
                          }
                        
                        }, {
                        
                          /**
                           * @attribute _DEFAULT
                           * @static
                           * @private
                           * @readOnly
                           * @type Object
                           */
                          _DEFAULTS: {
                            get methods() { return [&#x27;get&#x27;, &#x27;put&#x27;, &#x27;patch&#x27;, &#x27;delete&#x27;, &#x27;post&#x27;]; },
                            get maxLimit() { return 1000; },
                            get defaultLimit() { return 20; },
                            get countCacheExpiration() { return NOOT.Time.SECOND; },
                            get defaultResponseStatusCode() { return NOOT.HTTP.OK; },
                            get allowedResponseFields() { return [&#x27;data&#x27;, &#x27;message&#x27;, &#x27;error&#x27;, &#x27;meta&#x27;, &#x27;code&#x27;]; },
                            get defaultResponseType() { return &#x27;json&#x27;; },
                            get allowedResponseTypes() { return [&#x27;json&#x27;]; }
                          },
                        
                          /**
                           * Query modes
                           */
                          READ: QueryMode.create({}),
                          SELECT: QueryMode.create({}),
                          WRITE: QueryMode.create({}),
                          SORT: QueryMode.create({}),
                          FILTER: QueryMode.create({}),
                        
                          /**
                           * Module&#x27;s supported methods
                           */
                          _SUPPORTED_METHODS: [&#x27;get&#x27;, &#x27;put&#x27;, &#x27;patch&#x27;, &#x27;delete&#x27;, &#x27;post&#x27;],
                        
                          /**
                           * Ensure array only contains supported methods
                           *
                           * @param {Array} methods
                           */
                          validateMethods: function(methods) {
                            if (!NOOT.isArray(methods)) throw new Error(&#x27;&#x60;methods&#x60; should be an array of HTTP verbs&#x27;);
                            var supported = this._SUPPORTED_METHODS;
                            return methods.forEach(function(method) {
                              if (!~supported.indexOf(method)) throw new Error(&#x27;Method &quot;&#x27; + method + &#x27;&quot; is not supported&#x27;);
                            });
                          }
                        });
                        
                        
                        /**
                         * @exports
                         */
                        module.exports = Resource;
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
