<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/Users/sylvainestevez/Documents/Projects/Web/noot.js/src/api/lib/resource.js - NOOT.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="NOOT.js"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.5.5</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/NOOT.API.html">NOOT.API</a></li>
                                <li><a href="../classes/NOOT.API.Resource.html">NOOT.API.Resource</a></li>
                                <li><a href="../classes/NOOT.API.Route.html">NOOT.API.Route</a></li>
                                <li><a href="../classes/NOOT.Configurator.html">NOOT.Configurator</a></li>
                                <li><a href="../classes/NOOT.ContentType.html">NOOT.ContentType</a></li>
                                <li><a href="../classes/NOOT.CustomRequire.html">NOOT.CustomRequire</a></li>
                                <li><a href="../classes/NOOT.Error.html">NOOT.Error</a></li>
                                <li><a href="../classes/NOOT.Errors.html">NOOT.Errors</a></li>
                                <li><a href="../classes/NOOT.HTTP.html">NOOT.HTTP</a></li>
                                <li><a href="../classes/NOOT.Logger.html">NOOT.Logger</a></li>
                                <li><a href="../classes/NOOT.Mongoose.html">NOOT.Mongoose</a></li>
                                <li><a href="../classes/NOOT.Mongoose.Schema.html">NOOT.Mongoose.Schema</a></li>
                                <li><a href="../classes/NOOT.Namespace.html">NOOT.Namespace</a></li>
                                <li><a href="../classes/NOOT.NOOT.html">NOOT.NOOT</a></li>
                                <li><a href="../classes/NOOT.Object.html">NOOT.Object</a></li>
                                <li><a href="../classes/NOOT.TasksRunner.html">NOOT.TasksRunner</a></li>
                                <li><a href="../classes/NOOT.TasksRunner.Task.html">NOOT.TasksRunner.Task</a></li>
                                <li><a href="../classes/NOOT.Time.html">NOOT.Time</a></li>
                                <li><a href="../classes/NOOT.Time.Measure.html">NOOT.Time.Measure</a></li>
                                <li><a href="../classes/NOOT.Url.html">NOOT.Url</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /Users/sylvainestevez/Documents/Projects/Web/noot.js/src/api/lib/resource.js</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        /**
                         * Dependencies
                         */
                        var NOOT = require(&#x27;../../../&#x27;)(&#x27;object&#x27;, &#x27;url&#x27;, &#x27;time&#x27;);
                        var Inflector = require(&#x27;inflected&#x27;);
                        var _ = require(&#x27;lodash&#x27;);
                        var qs = require(&#x27;querystring&#x27;);
                        
                        var QueryMode = require(&#x27;./query-mode&#x27;);
                        var Route = require(&#x27;./route&#x27;);
                        var DefaultRoutes = require(&#x27;./default-routes&#x27;);
                        var CountCache = require(&#x27;./count-cache&#x27;);
                        
                        /***********************************************************************************************************************
                         * @class Resource
                         * @namespace NOOT.API
                         * @constructor
                         **********************************************************************************************************************/
                        var Resource = NOOT.Object.extend({
                        
                          model: null,
                          path: &#x27;&#x27;,
                          maxLimit: 0,
                          defaultLimit: 0,
                          countCacheExpiration: 0,
                        
                          methods: null,
                        
                          _routes: null,
                          _isComputed: false,
                        
                          selectable: null,
                          _selectable: null,
                          nonSelectable: null,
                          writable: null,
                          _writable: null,
                          nonWritable: null,
                          sortable: null,
                          _sortable: null,
                          nonSortable: null,
                          filterable: null,
                          _filterable: null,
                          nonFilterable: null,
                        
                          /**
                           * Constructor
                           */
                          init: function() {
                            NOOT.required(this, &#x27;api&#x27;, &#x27;model&#x27;);
                        
                            // Initialize routes
                            this._routes = [];
                        
                            // Path defaults to model name
                            this.path = this.path || NOOT.dasherize(Inflector.pluralize(this.model.modelName));
                        
                            // Methods
                            this.methods = this.methods ?
                              this.methods.map(function(method) { return method.toLowerCase(); }) :
                              Resource._getDefaultMethods();
                        
                            Resource.validateMethods(this.methods);
                        
                            // Limits
                            this.defaultLimit = this.defaultLimit || Resource._DEFAULTS.defaultLimit;
                            this.maxLimit = this.maxLimit || Resource._DEFAULTS.maxLimit;
                        
                            // Build allowed fields
                            this._buildFields();
                        
                            this._countCache = CountCache.create({
                              model: this.model,
                              expiration: this.countCacheExpiration || Resource.DEFAULTS.countCacheExpiration
                            });
                          },
                        
                        
                          getCount: function(filter, callback) {
                            return this._countCache.getCount(filter, callback);
                          },
                        
                          /**
                           * Build, sort and register routes on the app
                           */
                          getRoutes: function() {
                            if (this._isComputed) return this._routes;
                            this._isComputed = true;
                            return this._buildRoutes();
                          },
                        
                          /**
                           * C . . .
                           *
                           * Create a new item
                           *
                           * @param {Request} req
                           * @param {Response} res
                           * @param {Function} next
                           */
                          create: function(req, res, next) {
                            var self = this;
                            return this.model.create(this.filterFields(req.body, Resource.WRITE), function(err, item) {
                              if (err) return next(err);
                              return res.status(201).json({ data: self.filterFields(item.toObject(), Resource.READ) });
                            });
                          },
                        
                          /**
                           * Read multiple items
                           *
                           * @method getMultiple
                           * @async
                           * @param {Request} req
                           * @param {Function} callback
                           */
                          getMultiple: function(req, callback) {
                            var self = this;
                            var query = this.parseQueryString(req.query);
                        
                            return this.getCount(query.filter, function(err, count) {
                              if (err) return callback(err);
                        
                              var meta = self.getMeta(req, query, count);
                        
                              if (!count) return callback(null, { meta: meta, data: [] });
                        
                              return self.model.find(query.filter, query.select)
                                .limit(query.limit)
                                .skip(query.offset)
                                .sort(query.sort)
                                .exec(function(err, items) {
                                  if (err) return callback(err);
                                  return callback(null, { meta: meta, data: items });
                                });
                            });
                          },
                        
                          getSingle: function(req, callback) {
                            var query = this.parseQueryString(req.query);
                            return this.model.findById(req.param(&#x27;id&#x27;), query.select, { lean: true }, function(err, item) {
                              if (err) return callback(err);
                              if (!item) return callback(new NOOT.Errors.NotFound());
                              return callback(null, { data: item });
                            });
                          },
                        
                          /**
                           *
                           *
                           * @method respond
                           * @param {Response} res
                           * @param {Object} [data={}]
                           * @param {Number} [status=200]
                           */
                          respond: function(res, data, status) {
                            var args = NOOT.makeArray(arguments);
                            res = args.shift();
                        
                            var statusCode;
                            var json;
                        
                            switch (args.length) {
                              case 2:
                                if (NOOT.isNumber(options)) {
                                  statusCode = options;
                                  json = status;
                                } else {
                                  statusCode = status;
                                  json = options;
                                }
                                break;
                              case 1:
                                if (NOOT.isNumber(options)) {
                                  statusCode = options;
                                  json = {};
                                } else {
                                  json = options;
                                }
                                break;
                            }
                        
                            if (!statusCode) statusCode = 200;
                            if (!json) json = {};
                        
                            res.status(statusCode);
                            return res.json(_.pick(json, [&#x27;message&#x27;, &#x27;data&#x27;, &#x27;code&#x27;, &#x27;error&#x27;]));
                          },
                        
                          /**
                           * . R . .
                           *
                           * Read single/multiple item(s)
                           *
                           * @param {Request} req
                           * @param {Response} res
                           * @param {Function} next
                           */
                          read: function(req, res, next) {
                            var id = req.param(&#x27;id&#x27;);
                            var query = this.parseQueryString(req.query);
                        
                            if (id) {
                              return this.model.findById(id, query.select, { lean: true }, function(err, item) {
                                if (err) return next(err);
                                if (!item) return next();
                                return res.status(200).json({ data: item });
                              });
                            } else {
                              var self = this;
                              return this.getCount(query.filter, function(err, count) {
                                if (err) return next(err);
                        
                                var meta = self.getMeta(req, query, count);
                        
                                if (!count) return res.json({ meta: meta, data: [] });
                        
                                return self.model.find(query.filter, query.select)
                                  .limit(query.limit)
                                  .skip(query.offset)
                                  .sort(query.sort)
                                  .exec(function(err, items) {
                                    if (err) return next(err);
                                    return res.status(200).json({ meta: meta, data: items });
                                  });
                              });
                            }
                          },
                        
                          /**
                           * . . U .
                           *
                           * Update a single item
                           *
                           * @param {Request} req
                           * @param {Response} res
                           * @param {Function} next
                           */
                          update: function(req, res, next) {
                            var id = req.param(&#x27;id&#x27;);
                            var properties = this.filterFields(req.body, Resource.WRITE);
                            return this.model.update({ _id: id }, { $set: properties }, function(err, updated) {
                              if (err) return next(err);
                              if (!updated) return next();
                              return res.status(204).json();
                            });
                          },
                        
                          /**
                           * . . . D
                           *
                           * Delete a single item
                           *
                           * @param {Request} req
                           * @param {Response} res
                           * @param {Function} next
                           */
                          delete: function(req, res, next) {
                            var id = req.param(&#x27;id&#x27;);
                            return this.model.remove({ _id: id }, function(err, removed) {
                              if (err) return next(err);
                              if (!removed) return next();
                              return res.status(204).json();
                            });
                          },
                        
                          /**
                           * Parse offset, limit, filters, sorting and select from request query string
                           *
                           * @param {Object} query
                           * @returns {Object}
                           */
                          parseQueryString: function(query) {
                            return {
                              offset: parseInt(query.offset, 10) || 0,
                              limit: Math.min(parseInt(query.limit, 10) || this.defaultLimit, this.maxLimit),
                              filter: this.filterFields(query, Resource.FILTER),
                              sort: this.filterFields(query.sort, Resource.SORT) || &#x27;-_id&#x27;,
                              select: this.filterFields(query.select, Resource.SELECT) || this._selectable.join(&#x27; &#x27;)
                            };
                          },
                        
                          /**
                           * Build metadata for multiple reads (ie, GET without identifier)
                           *
                           * @param {Request} req
                           * @param {Object} query
                           * @param {Number} count
                           */
                          getMeta: function(req, query, count) {
                            var nextOffset = query.offset + query.limit;
                            var prevOffset = query.offset - query.limit;
                            return {
                              limit: query.limit,
                              offset: query.offset,
                              total: count,
                              next: nextOffset &lt; count ? this.getMetaNavLink(req, nextOffset, query.limit) : null,
                              prev: prevOffset &gt;= 0 ? this.getMetaNavLink(req, prevOffset, query.limit) : null
                            };
                          },
                        
                          /**
                           * Build new uri from the original, modifying limit and offset parameters
                           *
                           * @param {Request} req
                           * @param {Number} offset
                           * @param {Number} limit
                           * @returns {String}
                           */
                          getMetaNavLink: function(req, offset, limit) {
                            var query = _.clone(req.query);
                            query.offset = offset;
                            query.limit = limit;
                            return req._parsedUrl.pathname + &#x27;?&#x27; + qs.unescape(qs.stringify(query));
                          },
                        
                          /**
                           * Filter fields depending on query mode (read, write, select, sort...)
                           *
                           * @param {Array|Object} fields
                           * @param {QueryMode} queryMode
                           * @returns {Array|Object}
                           */
                          filterFields: function(fields, queryMode) {
                            if (!(queryMode instanceof QueryMode)) throw new Error(&#x27;Invalid query mode: &#x27; + queryMode);
                            switch (queryMode) {
                              case Resource.READ: return _.pick(fields, this._selectable);
                              case Resource.SELECT: return this.parseFieldsList(fields, this._selectable);
                              case Resource.WRITE: return _.pick(fields, this._writable);
                              case Resource.FILTER: return _.pick(fields, this._filterable);
                              case Resource.SORT: return this.parseFieldsList(fields, this._sortable);
                            }
                          },
                        
                          /**
                           * Parse fields from a comma separated list
                           *
                           * @param {String} fieldsStr
                           * @param {Array} allowedFields
                           * @returns {String}
                           */
                          parseFieldsList: function(fieldsStr, allowedFields) {
                            return (fieldsStr || &#x27;&#x27;)
                              .toString()
                              .split(/\s*,\s*/)
                              .filter(function(field) { return ~allowedFields.indexOf(field.replace(/^(\+|-)/, &#x27;&#x27;)); })
                              .join(&#x27; &#x27;);
                          },
                        
                          /**
                           * Build routes
                           *
                           * @private
                           */
                          _buildRoutes: function() {
                            var self = this;
                            this._routes = this.methods.map(function(method) {
                              var DefaultRoute = DefaultRoutes[method];
                              return DefaultRoute.create({
                                resource: self,
                                handlers: [self[DefaultRoute.defaultHandler].bind(self)]
                              });
                            });
                            return this._routes;
                          },
                        
                          /**
                           * Build allowed fields for all types
                           *
                           * @private
                           */
                          _buildFields: function() {
                            var self = this;
                            [&#x27;selectable&#x27;, &#x27;sortable&#x27;, &#x27;writable&#x27;, &#x27;filterable&#x27;].forEach(this._buildFieldsForType.bind(this));
                            // Security : don&#x27;t allow sorting, writing and filtering on non selectable fields
                            [&#x27;sortable&#x27;, &#x27;writable&#x27;, &#x27;filterable&#x27;].forEach(function(type) {
                              self[&#x27;_&#x27; + type] = _.intersection(self._selectable, self[&#x27;_&#x27; + type]);
                            });
                          },
                        
                          /**
                           * Build allowed fields for a single type
                           *
                           * @param {String} type
                           * @private
                           */
                          _buildFieldsForType: function(type) {
                            var allowed = this[type];
                            var disallowed = this[&#x27;non&#x27; + Inflector.classify(type)];
                            if (!allowed) allowed = this._getModelPaths();
                            if (disallowed) allowed = allowed.filter(function(field) { return !~disallowed.indexOf(field); });
                            this[&#x27;_&#x27; + type] = allowed;
                          },
                        
                          /**
                           * Get an exhaustive list of paths for model (nested paths use dot notation)
                           *
                           * @returns {Array}
                           * @private
                           */
                          _getModelPaths: function() {
                            return Object.keys(this.model.schema.paths);
                          }
                        
                        }, {
                        
                          /**
                           * Default values
                           */
                          _DEFAULTS: {
                            methods: [&#x27;get&#x27;, &#x27;put&#x27;, &#x27;patch&#x27;, &#x27;delete&#x27;, &#x27;post&#x27;],
                            maxLimit: 1000,
                            defaultLimit: 20,
                            countCacheExpiration: NOOT.Time.SECOND
                          },
                        
                          /**
                           * Query modes
                           */
                          READ: QueryMode.create({}),
                          SELECT: QueryMode.create({}),
                          WRITE: QueryMode.create({}),
                          SORT: QueryMode.create({}),
                          FILTER: QueryMode.create({}),
                        
                          /**
                           * Module&#x27;s supported methods
                           */
                          _SUPPORTED_METHODS: [&#x27;get&#x27;, &#x27;put&#x27;, &#x27;patch&#x27;, &#x27;delete&#x27;, &#x27;post&#x27;],
                        
                        
                          _getDefaultMethods: function() {
                            return Resource._DEFAULTS.methods.slice(0);
                          },
                        
                          /**
                           * Ensure array only contains supported methods
                           *
                           * @param {Array} methods
                           */
                          validateMethods: function(methods) {
                            if (!NOOT.isArray(methods)) throw new Error(&#x27;&#x60;methods&#x60; should be an array of HTTP verbs&#x27;);
                            var supported = this._SUPPORTED_METHODS;
                            return methods.forEach(function(method) {
                              if (!~supported.indexOf(method)) throw new Error(&#x27;Method &quot;&#x27; + method + &#x27;&quot; is not supported&#x27;);
                            });
                          }
                        });
                        
                        
                        /**
                         * @exports
                         */
                        module.exports = Resource;
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
